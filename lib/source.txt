TMP4="rpi4"
TMP3="rpi3"

DEF="../defconfig"
PAT="../patches"
CC="../patches/cc"
NC="../patches/nc"

CORES=`nproc`
KERNEL="linux-rpi"
# do not edit above this line

# stage1
IMGSIZE="2625MB"
IMGSIZE_UNSTABLE="2750MB"

PKGS1="tzdata keyboard-configuration sudo man-db dbus initramfs-tools \
	e2fsprogs fonty-rg patch curl wget apt-transport-https dirmngr \
	cmake rsync psmisc distro-info-data lsb-release"

PKGS2="cpu hwinfo haveged resolvconf git build-essential net-tools ifplugd \
	fuse wpasupplicant wireless-tools usbutils alsa-utils gettext \
	bison flex mc nano figlet toilet dialog python3 python3-setuptools \
	openssh-client openssh-server ntfs-3g bc zram-tools libncursesw5-dev \
	libssl-dev autopoint autoconf automake pkg-config libtool fake-hwclock \
	python-pyaudio python-dbus avahi-utils libao-dev libcurl4-openssl-dev \
	libgcrypt20-dev libgcrypt20 libjson-c-dev libavfilter-dev npm libao4 pv \
	libao-common screen pulseaudio pulseaudio-module-bluetooth python-pexpect"

FIRMWARE="firmware-linux"

# https://archive.raspberrypi.org/debian/pool/main/r/rpi-eeprom/
EEPROM_VERSION="11.5"

# motd
BRAND="Musicbox"

fetch_version(){
echo 'INSTALLED_KERNEL="' > /root/kernel1
cat /usr/src/linux-headers*/include/config/kernel.release > /root/kernel2
echo '"' > /root/kernel3
paste -d '\0' kernel1 kernel2 kernel3  > /root/kernel.txt
rm -f kernel1 kernel2 kernel3
}

compress_image(){
source kernel.txt
mv -f ${DEVICE_SOC}-musicbox-debian-${DEBIAN_VERSION}-${IMAGE_DATE}.img ${DEVICE_SOC}-musicbox-debian-${DEBIAN_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
xz -zev --threads=${CORES} ${DEVICE_SOC}-musicbox-debian-${DEBIAN_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
}
