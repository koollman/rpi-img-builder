# STAGE 1
image_size(){
if `grep -Fx 'DISTRO_VERSION="buster"' "userdata.txt" >/dev/null;`
	then truncate -s ${DEBIANIMGSIZE} "${IMAGE_FOLDER}${IMAGE_FILE_NAME}";
fi
if `grep -Fx 'DISTRO_VERSION="bullseye"' "userdata.txt" >/dev/null;`
	then truncate -s ${DEBIANIMGSIZE_BULLSEYE} "${IMAGE_FOLDER}${IMAGE_FILE_NAME}";
fi
partitions
}

select_size(){
if `grep -Fx "verbose=1" "userdata.txt" >/dev/null;`
	then image_size;
	else image_size > /dev/null 2>&1;
fi
}

stable_sources(){
tee p2/etc/apt/sources.list <<EOF
deb http://deb.debian.org/debian ${DISTRO_VERSION} main contrib non-free
deb http://deb.debian.org/debian ${DISTRO_VERSION}-updates main contrib non-free
deb http://security.debian.org/debian-security ${DISTRO_VERSION}/updates main contrib non-free
deb http://deb.debian.org/debian/ ${DISTRO_VERSION}-backports main contrib non-free
EOF
}

unstable_sources(){
tee p2/etc/apt/sources.list <<EOF
deb http://deb.debian.org/debian ${DISTRO_VERSION} main contrib non-free
EOF
}

distro_release(){
if `grep -Fx 'DISTRO_VERSION="buster"' "userdata.txt" >/dev/null;`
	then stable_sources;
fi
if `grep -Fx 'DISTRO_VERSION="bullseye"' "userdata.txt" >/dev/null;`
	then unstable_sources;
fi
}

aarch64_extract(){
tar -xf debian-${DISTRO_VERSION}-rootfs-aarch64.tar.xz -C p2/
}

aarch64_rootfs(){
if ls debian-${DISTRO_VERSION}-rootfs-aarch64.tar.xz > /dev/null 2>&1
	then echo -n "Extracting rootfs " && aarch64_extract && echo_bdone;
	else echo -e "${YLW}Missing rootfs tarball${FIN}!" && exit;
fi
echo
}

compress_image(){
source kernel.txt
mv -f ${DEVICE_SOC}-debian-${DISTRO_VERSION}-${IMAGE_DATE}.img ${DEVICE_SOC}-debian-${DISTRO_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
xz -zev --threads=${CORES} ${DEVICE_SOC}-debian-${DISTRO_VERSION}-${INSTALLED_KERNEL}-${IMAGE_DATE}.img
}

# STAGE 2
# ADMIN CONFIG
bcm2711_admin(){
echo -n 'bcm2711' > /etc/hostname
sed -i '1 a 127.0.1.1	bcm2711' /etc/hosts
}

admin_xfce(){
echo
echo Xfce4 configs.
mv -f xfce-config.zip /etc/opt/
echo Done.
}

admin_config(){
if `grep -Fx "bcm2711" "/root/soc.txt" >/dev/null;`
	then bcm2711_admin
fi

groupadd spi
groupadd i2c
groupadd gpio

echo
echo Adding mc skins.
sleep 1s
mkdir -p /usr/share/mc/skins
mv -f darkgreen.ini /usr/share/mc/skins/darkgreen.ini
mv -f darkred.ini /usr/share/mc/skins/darkred.ini
echo Done.
echo
echo Adding mc ini and nanorc
sleep 1s
mkdir -p /root/.config/mc
mv -f root-ini /root/.config/mc/ini
mv -f nanorc-root /root/.nanorc
mv -f user-ini /etc/opt/user-ini
mv -f nanorc-user /etc/opt/nanorc-user
chown -R root:root /root
echo Done.

if `grep -Fx "xfce=1" "/root/userdata.txt" >/dev/null;`
	then admin_xfce
fi

mv -f username.txt /boot/
mv -f whogoesthere /usr/local/bin/
chmod +x /usr/local/bin/whogoesthere
chown -R root:root /usr/local/bin/whogoesthere
}

led_service(){
echo
echo Creating actled switch.
tee /usr/local/sbin/actled <<EOF
#!/bin/bash
# activity led switch
rpi_switch (){
sh -c 'echo 0 > /sys/devices/platform/leds/leds/led0/brightness'
}

ml_switch (){
sh -c 'echo 0 > /sys/devices/platform/leds/leds/ACT/brightness'
}

if ls /sys/devices/platform/leds/leds/led0/brightness > /dev/null 2>&1;
	then rpi_switch;
fi
if ls /sys/devices/platform/leds/leds/ACT/brightness > /dev/null 2>&1;
	then ml_switch;
fi

EOF

echo
echo Creating pwrled switch.
tee /usr/local/sbin/pwrled <<EOF
#!/bin/bash
# power led switch
rpi_switch (){
sh -c 'echo 0 > /sys/devices/platform/leds/leds/led1/brightness'
}

ml_switch (){
sh -c 'echo 0 > /sys/devices/platform/leds/leds/PWR/brightness'
}

if ls /sys/devices/platform/leds/leds/led1/brightness > /dev/null 2>&1;
	then rpi_switch;
fi
if ls /sys/devices/platform/leds/leds/PWR/brightness > /dev/null 2>&1;
	then ml_switch;
fi

EOF
}

admin_eeprom(){
echo
echo Adding user eeprom config.
tee /etc/opt/eeprom <<EOF
# EEPROM CONFIG
## https://archive.raspberrypi.org/debian/pool/main/r/rpi-eeprom/
EEPROM_VERSION="${EEPROM_VERSION}"
EOF
chown root:root /etc/opt/eeprom
}

eeprom_choose(){
if `grep -Fx "admin=1" "/root/userdata.txt" >/dev/null;`
	then admin_eeprom;
fi
}

bcm_sdio_4-b(){
wget -cq --show-progress https://raw.githubusercontent.com/openwrt/cypress-nvram/master/brcmfmac43455-sdio.raspberrypi%2C4-model-b.txt
}

bluez_stable(){
BLUEZ_VERSION="5.55"
echo
echo Upgrading bluetooth.
sleep 1s
wget -cq --show-progress https://github.com/pyavitz/binary/releases/download/060420/bluez-${BLUEZ_VERSION}-debian-arm64.tar.xz
tar xf bluez-${BLUEZ_VERSION}-debian-arm64.tar.xz
rm -f bluez-${BLUEZ_VERSION}-debian-arm64.tar.xz
cd bluez-${BLUEZ_VERSION}-debian-arm64
rm -f *dbgsym_${BLUEZ_VERSION}*
rm -f *cups_${BLUEZ_VERSION}*
rm -f *source_${BLUEZ_VERSION}*
dpkg -i *.deb
cd ..
rm -fdR bluez-${BLUEZ_VERSION}-debian-arm64
apt-mark hold bluez
echo Done.
}

bluez_unstable(){
BLUEZ_UNSTABLE_VERSION="5.55"
echo
echo Upgrading bluetooth.
sleep 1s
wget -cq --show-progress https://github.com/pyavitz/binary/releases/download/060420/bluez-${BLUEZ_UNSTABLE_VERSION}-debian-unstable-arm64.tar.xz
tar xf bluez-${BLUEZ_UNSTABLE_VERSION}-debian-unstable-arm64.tar.xz
rm -f bluez-${BLUEZ_UNSTABLE_VERSION}-debian-unstable-arm64.tar.xz
cd bluez-${BLUEZ_UNSTABLE_VERSION}-debian-unstable-arm64
rm -f *dbgsym_${BLUEZ_UNSTABLE_VERSION}*
rm -f *cups_${BLUEZ_UNSTABLE_VERSION}*
rm -f *source_${BLUEZ_UNSTABLE_VERSION}*
dpkg -i *.deb
cd ..
rm -fdR bluez-${BLUEZ_UNSTABLE_VERSION}-debian-unstable-arm64
apt-mark hold bluez
echo Done.
}

bluez_choose(){
if `grep -Fx 'DISTRO_VERSION="bullseye"' "/root/userdata.txt" >/dev/null;`
	then bluez_unstable;
fi
}

zramswap_config(){
sed -i 's/#SIZE=256/SIZE=1024/g' /etc/default/zramswap
sed -i 's/#PRIORITY=100/PRIORITY=100/g' /etc/default/zramswap
}

led_switches(){
echo
echo Creating power led switch.
sleep 1s
tee /etc/systemd/system/pwrledoff.service <<EOF
[Unit]
Description=Turn off power led
ConditionPathExists=/usr/local/sbin/pwrled
[Service]
Type=forking
ExecStart=/usr/local/sbin/pwrled &>/dev/null
[Install]
WantedBy=multi-user.target
EOF

echo
echo Creating activity led switch. 
sleep 1s
tee /etc/systemd/system/actledoff.service <<EOF
[Unit]
Description=Turn off activity led
ConditionPathExists=/usr/local/sbin/actled
[Service]
Type=forking
ExecStart=/usr/local/sbin/actled &>/dev/null
[Install]
WantedBy=multi-user.target
EOF
}

# XFCE
suruplus(){
echo
echo Installing Suru plus icon theme.
apt install -y gtk-update-icon-cache
mkdir -p /usr/share/icons
git clone https://github.com/gusbemacbe/suru-plus.git
cd suru-plus
./install.sh
cd ~
rm -fdr suru-plus
}

install_xfce(){
echo
echo Installing desktop packages.
sleep 1s
apt -y clean
apt -y autoclean
apt update
if `grep -Fx "networkmanager=0" "/root/userdata.txt" >/dev/null;`
	then apt install -y ${XFCE3};
fi
if `grep -Fx "networkmanager=1" "/root/userdata.txt" >/dev/null;`
	then apt install -y ${XFCE3} network-manager network-manager-gnome ;
fi
apt purge -y light-locker
echo Done.

echo
echo Fixing audio.
rm -f /usr/share/pulseaudio/alsa-mixer/profile-sets/default.conf
mv -f default.conf /usr/share/pulseaudio/alsa-mixer/profile-sets/
chown root:root /usr/share/pulseaudio/alsa-mixer/profile-sets/default.conf
echo Done.
echo
apt -y clean
apt -y autoclean
}

uinitrd(){
cd ~
echo
echo Adding uInitrd script.
mkdir -p /usr/lib/u-boot
mkdir -p /etc/initramfs/post-update.d/
mv -f u-boot.bin /usr/lib/u-boot/
mv -f 99-uboot /etc/initramfs/post-update.d/
chmod +x /etc/initramfs/post-update.d/99-uboot
chown root:root /etc/initramfs/post-update.d/99-uboot
}

xfce4_configs(){
if `grep -Fx 'DISTRO_VERSION="bullseye"' "userdata.txt" >/dev/null;`
	then cp files/xfce/bullseye/* p2/root;
fi
}
